<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Outlook Mail Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            max-width: 100%;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 16px 24px 16px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34c759;
            box-shadow: 0 0 8px rgba(52, 199, 89, 0.6);
        }

        .status-dot.disconnected {
            background: #ff3b30;
            box-shadow: 0 0 8px rgba(255, 59, 48, 0.6);
        }

        .user-email {
            font-size: 12px;
            opacity: 0.9;
        }

        .sync-time {
            font-size: 12px;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .action-buttons::-webkit-scrollbar {
            display: none;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
        }

        .btn-primary:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.85);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            padding: 0;
        }

        .controls-section {
            background: white;
            padding: 16px;
            margin: 16px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-box {
            position: relative;
            margin-bottom: 12px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: #f5f5f7;
        }

        .search-box input:focus {
            outline: none;
            background: #e8e8ed;
        }

        .filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 4px 0;
        }

        .filters::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 36px;
        }

        .filter-chip.active {
            background: #667eea;
            color: white;
        }

        .filter-chip:active {
            transform: scale(0.96);
        }

        .email-list {
            padding: 0 16px 100px 16px;
        }

        .email-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .email-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .email-card-content {
            padding: 16px;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .email-subject {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
            line-height: 1.3;
            flex: 1;
            margin-right: 12px;
        }

        .email-time {
            font-size: 13px;
            color: #86868b;
            white-space: nowrap;
        }

        .email-from {
            font-size: 15px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .email-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-new {
            background: #007aff;
            color: white;
        }

        .badge-unread {
            background: #ff3b30;
            color: white;
        }

        .badge-status {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .badge-status.done {
            background: #34c759;
            color: white;
        }

        .badge-status.in-progress {
            background: #007aff;
            color: white;
        }

        .badge-status.waiting {
            background: #ff9500;
            color: white;
        }

        .badge-priority {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .badge-priority.high {
            background: #ff3b30;
            color: white;
        }

        .badge-priority.medium {
            background: #ff9500;
            color: white;
        }

        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .bottom-sheet-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 1001;
            max-height: 85vh;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 5px;
            background: #d1d1d6;
            border-radius: 3px;
            margin: 12px auto 8px;
            flex-shrink: 0;
        }

        .sheet-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid #f5f5f7;
            flex-shrink: 0;
        }

        .sheet-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .sheet-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 13px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .detail-field {
            margin-bottom: 16px;
        }

        .detail-field label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .detail-field input,
        .detail-field select,
        .detail-field textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: #f5f5f7;
        }

        .detail-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .detail-field input:focus,
        .detail-field select:focus,
        .detail-field textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .detail-value {
            font-size: 15px;
            color: #1d1d1f;
            line-height: 1.5;
            padding: 12px;
            background: #f5f5f7;
            border-radius: 10px;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h2 {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .modal p {
            font-size: 15px;
            color: #86868b;
            margin-bottom: 20px;
        }

        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 20px 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            background: #f5f5f7;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
        }

        .folder-item:active {
            transform: scale(0.98);
        }

        .folder-item.selected {
            background: #e8e5ff;
            border: 2px solid #667eea;
        }

        .folder-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .folder-name {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .folder-count {
            font-size: 14px;
            color: #86868b;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .btn {
            flex: 1;
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 32px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .empty-state p {
            font-size: 15px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 12px;
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid #f5f5f7;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .settings-card {
            background: white;
            border-radius: 16px;
            margin: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .settings-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 16px;
        }

        .setting-row {
            margin-bottom: 16px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-row label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .setting-row select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            font-size: 16px;
            background: #f5f5f7;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            margin: 16px;
            font-size: 14px;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 10px;
            margin: 16px;
            font-size: 14px;
        }

        @supports (padding: max(0px)) {
            .header {
                padding-top: max(20px, env(safe-area-inset-top));
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const CLIENT_ID = 'd3590ed6-52b3-4102-aeff-aad2292ab01c';
        const REDIRECT_URI = window.location.href.split('?')[0].split('#')[0];
        const TENANT = 'common';
        const SCOPES = 'User.Read Mail.Read Mail.ReadBasic MailboxSettings.Read';
        
        let accessToken = null;
        let userEmail = 'lgarwood@merionhp.com';

        function initiateLogin() {
            const authUrl = `https://login.microsoftonline.com/${TENANT}/oauth2/v2.0/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `response_mode=fragment&` +
                `login_hint=${encodeURIComponent(userEmail)}`;
            
            window.location.href = authUrl;
        }

        function checkForToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            if (params.has('access_token')) {
                accessToken = params.get('access_token');
                window.history.replaceState(null, '', window.location.pathname);
                return true;
            }
            
            const stored = localStorage.getItem('outlook_access_token');
            if (stored) {
                const tokenData = JSON.parse(stored);
                if (tokenData.expires > Date.now()) {
                    accessToken = tokenData.token;
                    userEmail = tokenData.email || userEmail;
                    return true;
                }
            }
            
            return false;
        }

        function saveToken(token, email) {
            localStorage.setItem('outlook_access_token', JSON.stringify({
                token: token,
                email: email,
                expires: Date.now() + (3600 * 1000)
            }));
        }

        function clearToken() {
            accessToken = null;
            localStorage.removeItem('outlook_access_token');
        }

        async function callGraphAPI(endpoint) {
            if (!accessToken) {
                throw new Error('No access token available');
            }

            const response = await fetch('https://graph.microsoft.com/v1.0' + endpoint, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    clearToken();
                    throw new Error('Token expired. Please sign in again.');
                }
                throw new Error(`Graph API error: ${response.status}`);
            }

            return await response.json();
        }

        async function getUserInfo() {
            try {
                const data = await callGraphAPI('/me');
                return data.mail || data.userPrincipalName;
            } catch (error) {
                console.error('Error getting user info:', error);
                return userEmail;
            }
        }

        async function loadFolders() {
            try {
                setState({ isLoading: true, error: null });
                const data = await callGraphAPI('/me/mailFolders?$top=50');
                const folders = data.value.map(folder => ({
                    id: folder.id,
                    name: folder.displayName,
                    totalItemCount: folder.totalItemCount || 0,
                    unreadItemCount: folder.unreadItemCount || 0
                }));
                setState({ 
                    folders: folders,
                    isLoading: false,
                    showFolderModal: true
                });
            } catch (error) {
                console.error('Error loading folders:', error);
                setState({ 
                    isLoading: false,
                    error: error.message || 'Failed to load folders. Please try again.'
                });
            }
        }

        async function loadEmails(folderIds) {
            try {
                setState({ isLoading: true, error: null });
                let allEmails = [];

                for (const folderId of folderIds) {
                    try {
                        const data = await callGraphAPI(`/me/mailFolders/${folderId}/messages?$top=50&$select=id,subject,from,receivedDateTime,isRead,importance,bodyPreview,toRecipients,ccRecipients`);
                        const emails = data.value.map(msg => ({
                            id: msg.id,
                            subject: msg.subject || '(No Subject)',
                            from: msg.from?.emailAddress?.address || 'Unknown',
                            fromName: msg.from?.emailAddress?.name || msg.from?.emailAddress?.address || 'Unknown',
                            receivedDate: msg.receivedDateTime,
                            folder: state.folders.find(f => f.id === folderId)?.name || 'Unknown',
                            folderId: folderId,
                            status: 'To Do',
                            priority: msg.importance === 'high' ? 'High' : msg.importance === 'low' ? 'Low' : 'Medium',
                            owner: '',
                            notes: '',
                            isNew: false,
                            isUnread: !msg.isRead,
                            body: msg.bodyPreview || '',
                            to: msg.toRecipients?.map(r => r.emailAddress.address).join(', ') || '',
                            cc: msg.ccRecipients?.map(r => r.emailAddress.address).join(', ') || ''
                        }));
                        allEmails = allEmails.concat(emails);
                    } catch (error) {
                        console.error(`Error loading emails from folder ${folderId}:`, error);
                    }
                }

                setState({
                    emails: allEmails,
                    isLoading: false,
                    lastSync: new Date(),
                    showFolderModal: false
                });
            } catch (error) {
                console.error('Error loading emails:', error);
                setState({ 
                    isLoading: false,
                    error: error.message || 'Failed to load emails. Please try again.'
                });
            }
        }

        async function syncEmails() {
            if (state.selectedFolders.length === 0) {
                setState({ error: 'No folders selected. Please select folders first.' });
                return;
            }
            await loadEmails(state.selectedFolders);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return diffMins + 'm';
            if (diffHours < 24) return diffHours + 'h';
            if (diffDays < 7) return diffDays + 'd';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        let state = {
            isConnected: false,
            userEmail: '',
            emails: [],
            folders: [],
            selectedFolders: [],
            selectedEmail: null,
            showDetailsPanel: false,
            showFolderModal: false,
            showSettings: false,
            isLoading: false,
            lastSync: null,
            searchTerm: '',
            statusFilter: 'All',
            priorityFilter: 'All',
            folderFilter: 'All',
            sortField: 'receivedDate',
            sortDirection: 'desc',
            defaultStatus: 'To Do',
            error: null
        };

        function setState(updates) {
            state = { ...state, ...updates };
            render();
        }

        async function handleConnect() {
            setState({ isLoading: true, error: null });
            initiateLogin();
        }

        async function handleDisconnect() {
            clearToken();
            setState({
                isConnected: false,
                userEmail: '',
                emails: [],
                folders: [],
                selectedFolders: [],
                selectedEmail: null,
                showDetailsPanel: false,
                lastSync: null
            });
        }

        function toggleFolder(folderId) {
            const selected = state.selectedFolders.includes(folderId)
                ? state.selectedFolders.filter(id => id !== folderId)
                : [...state.selectedFolders, folderId];
            setState({ selectedFolders: selected });
        }

        function handleLoadEmails() {
            loadEmails(state.selectedFolders);
        }

        function handleSync() {
            syncEmails();
        }

        function handleEmailClick(email) {
            const updated = state.emails.map(e => 
                e.id === email.id ? { ...e, isNew: false } : e
            );
            setState({
                selectedEmail: email,
                showDetailsPanel: true,
                emails: updated
            });
        }

        function handleUpdateEmail(field, value) {
            if (!state.selectedEmail) return;
            const updated = { ...state.selectedEmail, [field]: value };
            setState({
                selectedEmail: updated,
                emails: state.emails.map(e => e.id === updated.id ? updated : e)
            });
        }

        function closeDetailsPanel() {
            setState({ showDetailsPanel: false });
        }

        function handleExport() {
            const headers = ['Subject', 'From', 'Received Date', 'Folder', 'Status', 'Priority', 'Owner', 'Notes'];
            const rows = getFilteredEmails().map(email => [
                email.subject,
                email.from,
                new Date(email.receivedDate).toLocaleString(),
                email.folder,
                email.status,
                email.priority,
                email.owner,
                email.notes
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => '"' + (cell || '') + '"').join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'outlook-tracker-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function getFilteredEmails() {
            let filtered = state.emails;

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filtered = filtered.filter(email => 
                    email.subject.toLowerCase().includes(term) ||
                    email.from.toLowerCase().includes(term) ||
                    email.notes.toLowerCase().includes(term)
                );
            }

            if (state.statusFilter !== 'All') {
                filtered = filtered.filter(email => email.status === state.statusFilter);
            }

            if (state.priorityFilter !== 'All') {
                filtered = filtered.filter(email => email.priority === state.priorityFilter);
            }

            if (state.folderFilter !== 'All') {
                filtered = filtered.filter(email => email.folder === state.folderFilter);
            }

            filtered.sort((a, b) => {
                let aVal = a[state.sortField];
                let bVal = b[state.sortField];

                if (state.sortField === 'receivedDate') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (aVal < bVal) return state.sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return state.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }

        function render() {
            const app = document.getElementById('root');
            const filteredEmails = getFilteredEmails();

            app.innerHTML = `
                <div class="app-container">
                    <div class="header">
                        <div class="header-title">
                            <h1>üìß Mail Tracker</h1>
                        </div>
                        <div class="status-bar">
                            <div class="connection-badge">
                                <div class="status-dot ${state.isConnected ? 'connected' : 'disconnected'}"></div>
                                ${state.isConnected ? 'Connected' : 'Not Connected'}
                            </div>
                            ${state.userEmail ? `<div class="user-email">${state.userEmail}</div>` : ''}
                            ${state.lastSync ? `<div class="sync-time">Synced: ${state.lastSync.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : ''}
                        </div>
                        <div class="action-buttons">
                            ${state.isConnected ? `
                                <button class="btn btn-secondary" onclick="setState({showFolderModal: true})">
                                    üìÅ Folders
                                </button>
                                <button class="btn btn-secondary" onclick="handleSync()" ${state.isLoading ? 'disabled' : ''}>
                                    üîÑ Sync
                                </button>
                                <button class="btn btn-secondary" onclick="setState({showSettings: !state.showSettings})">
                                    ‚öôÔ∏è Settings
                                </button>
                                <button class="btn btn-secondary" onclick="handleExport()">
                                    üíæ Export
                                </button>
                                <button class="btn btn-primary" onclick="handleDisconnect()">
                                    ‚éã Disconnect
                                </button>
                            ` : `
                                <button class="btn btn-primary" onclick="handleConnect()" ${state.isLoading ? 'disabled' : ''} style="flex: 1">
                                    ${state.isLoading ? '‚è≥ Connecting...' : 'üîó Connect to Outlook'}
                                </button>
                            `}
                        </div>
                    </div>

                    ${state.error ? `
                        <div class="error-message">
                            ‚ö†Ô∏è ${state.error}
                        </div>
                    ` : ''}

                    <div class="main-content">
                        ${!state.isConnected ? `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìß</div>
                                <h3>Connect Your Outlook</h3>
                                <p>Sign in with lgarwood@merionhp.com to start tracking your emails</p>
                                <button class="btn btn-primary" onclick="handleConnect()" ${state.isLoading ? 'disabled' : ''}>
                                    ${state.isLoading ? '‚è≥ Connecting...' : 'üîó Connect to Outlook'}
                                </button>
                            </div>
                        ` : state.emails.length === 0 ? `
                            <div class="empty-state">
                                <div class="empty-state-icon">üì•</div>
                                <h3>No Emails Loaded</h3>
                                <p>Select folders to start tracking your emails</p>
                                <button class="btn btn-primary" onclick="setState({showFolderModal: true})">
                                    üìÅ Select Folders
                                </button>
                            </div>
                        ` : `
                            ${state.showSettings ? `
                                <div class="settings-card">
                                    <h3>‚öôÔ∏è Settings</h3>
                                    <div class="setting-row">
                                        <label>Default Status for New Emails</label>
                                        <select value="${state.defaultStatus}" onchange="setState({defaultStatus: this.value})">
                                            <option>To Do</option>
                                            <option>In Progress</option>
                                            <option>Waiting</option>
                                            <option>Done</option>
                                            <option>Archived</option>
                                        </select>
                                    </div>
                                    <div class="setting-row">
                                        <label>Sort Order</label>
                                        <select value="${state.sortField}-${state.sortDirection}" onchange="
                                            const [field, dir] = this.value.split('-');
                                            setState({sortField: field, sortDirection: dir});
                                        ">
                                            <option value="receivedDate-desc">Newest First</option>
                                            <option value="receivedDate-asc">Oldest First</option>
                                            <option value="subject-asc">Subject A-Z</option>
                                            <option value="status-asc">Status</option>
                                            <option value="priority-desc">Priority</option>
                                        </select>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="controls-section">
                                <div class="search-box">
                                    <input 
                                        type="text" 
                                        placeholder="üîç Search emails..."
                                        value="${state.searchTerm}"
                                        oninput="setState({searchTerm: this.value})"
                                    />
                                </div>
                                <div class="filters">
                                    <button class="filter-chip ${state.statusFilter === 'All' ? 'active' : ''}" 
                                            onclick="setState({statusFilter: 'All'})">All Status</button>
                                    <button class="filter-chip ${state.statusFilter === 'To Do' ? 'active' : ''}" 
                                            onclick="setState({statusFilter: 'To Do'})">To Do</button>
                                    <button class="filter-chip ${state.statusFilter === 'In Progress' ? 'active' : ''}" 
                                            onclick="setState({statusFilter: 'In Progress'})">In Progress</button>
                                    <button class="filter-chip ${state.statusFilter === 'Done' ? 'active' : ''}" 
                                            onclick="setState({statusFilter: 'Done'})">Done</button>
                                    <button class="filter-chip ${state.priorityFilter === 'All' ? 'active' : ''}" 
                                            onclick="setState({priorityFilter: 'All'})">All Priority</button>
                                    <button class="filter-chip ${state.priorityFilter === 'High' ? 'active' : ''}" 
                                            onclick="setState({priorityFilter: 'High'})">High</button>
                                    <button class="filter-chip ${state.priorityFilter === 'Medium' ? 'active' : ''}" 
                                            onclick="setState({priorityFilter: 'Medium'})">Medium</button>
                                </div>
                            </div>

                            <div class="email-list">
                                ${filteredEmails.map(email => `
                                    <div class="email-card" onclick='handleEmailClick(${JSON.stringify(email).replace(/'/g, "&#39;")})'>
                                        <div class="email-card-content">
                                            <div class="email-header">
                                                <div class="email-subject">${email.subject}</div>
                                                <div class="email-time">${formatDate(email.receivedDate)}</div>
                                            </div>
                                            <div class="email-from">${email.fromName || email.from}</div>
                                            <div class="email-meta">
                                                ${email.isNew ? '<span class="badge badge-new">New</span>' : ''}
                                                ${email.isUnread ? '<span class="badge badge-unread">Unread</span>' : ''}
                                                <span class="badge badge-status ${email.status.toLowerCase().replace(' ', '-')}">${email.status}</span>
                                                <span class="badge badge-priority ${email.priority.toLowerCase()}">${email.priority}</span>
                                                <span class="badge">${email.folder}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            ${filteredEmails.length < state.emails.length ? `
                                <div style="text-align: center; padding: 20px; color: #86868b;">
                                    Showing ${filteredEmails.length} of ${state.emails.length} emails
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <div class="bottom-sheet-overlay ${state.showDetailsPanel ? 'active' : ''}" onclick="closeDetailsPanel()"></div>
                    <div class="bottom-sheet ${state.showDetailsPanel ? 'active' : ''}">
                        ${state.selectedEmail ? `
                            <div class="sheet-handle"></div>
                            <div class="sheet-header">
                                <h2>Email Details</h2>
                            </div>
                            <div class="sheet-content">
                                <div class="detail-section">
                                    <h3>üìß Email Information</h3>
                                    <div class="detail-field">
                                        <label>Subject</label>
                                        <div class="detail-value">${state.selectedEmail.subject}</div>
                                    </div>
                                    <div class="detail-field">
                                        <label>From</label>
                                        <div class="detail-value">${state.selectedEmail.fromName || state.selectedEmail.from}</div>
                                    </div>
                                    <div class="detail-field">
                                        <label>To</label>
                                        <div class="detail-value">${state.selectedEmail.to || 'N/A'}</div>
                                    </div>
                                    <div class="detail-field">
                                        <label>Received</label>
                                        <div class="detail-value">${new Date(state.selectedEmail.receivedDate).toLocaleString()}</div>
                                    </div>
                                    <div class="detail-field">
                                        <label>Folder</label>
                                        <div class="detail-value">${state.selectedEmail.folder}</div>
                                    </div>
                                    <div class="detail-field">
                                        <label>Preview</label>
                                        <div class="detail-value">${state.selectedEmail.body || 'No preview available'}</div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h3>üìù Tracking Fields</h3>
                                    <div class="detail-field">
                                        <label>Status</label>
                                        <select value="${state.selectedEmail.status}" 
                                                onchange="handleUpdateEmail('status', this.value)">
                                            <option>To Do</option>
                                            <option>In Progress</option>
                                            <option>Waiting</option>
                                            <option>Done</option>
                                            <option>Archived</option>
                                        </select>
                                    </div>
                                    <div class="detail-field">
                                        <label>Priority</label>
                                        <select value="${state.selectedEmail.priority}" 
                                                onchange="handleUpdateEmail('priority', this.value)">
                                            <option>High</option>
                                            <option>Medium</option>
                                            <option>Low</option>
                                            <option>None</option>
                                        </select>
                                    </div>
                                    <div class="detail-field">
                                        <label>Owner</label>
                                        <input 
                                            type="text" 
                                            value="${state.selectedEmail.owner}"
                                            placeholder="Assign to..."
                                            oninput="handleUpdateEmail('owner', this.value)"
                                        />
                                    </div>
                                    <div class="detail-field">
                                        <label>Notes</label>
                                        <textarea
                                            placeholder="Add tracking notes..."
                                            oninput="handleUpdateEmail('notes', this.value)"
                                        >${state.selectedEmail.notes}</textarea>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="modal-overlay ${state.showFolderModal ? 'active' : ''}" onclick="setState({showFolderModal: false})">
                        <div class="modal" onclick="event.stopPropagation()">
                            <h2>Select Folders</h2>
                            <p>Choose which Outlook folders to track</p>
                            <div class="folder-list">
                                ${state.folders.map(folder => `
                                    <div class="folder-item ${state.selectedFolders.includes(folder.id) ? 'selected' : ''}"
                                         onclick="toggleFolder('${folder.id}')">
                                        <input 
                                            type="checkbox" 
                                            ${state.selectedFolders.includes(folder.id) ? 'checked' : ''}
                                            onclick="event.stopPropagation(); toggleFolder('${folder.id}')"
                                        />
                                        <span class="folder-name">${folder.name}</span>
                                        <span class="folder-count">${folder.totalItemCount}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="setState({showFolderModal: false})">
                                    Cancel
                                </button>
                                <button 
                                    class="btn btn-primary" 
                                    onclick="handleLoadEmails()"
                                    ${state.selectedFolders.length === 0 || state.isLoading ? 'disabled' : ''}
                                >
                                    ${state.isLoading ? '‚è≥ Loading...' : `Load ${state.selectedFolders.length} Folder${state.selectedFolders.length !== 1 ? 's' : ''}`}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function init() {
            const hasToken = checkForToken();
            
            if (hasToken && accessToken) {
                try {
                    const email = await getUserInfo();
                    saveToken(accessToken, email);
                    setState({ 
                        isConnected: true,
                        userEmail: email
                    });
                    await loadFolders();
                } catch (error) {
                    console.error('Initialization error:', error);
                    clearToken();
                    setState({ 
                        isConnected: false,
                        error: 'Session expired. Please sign in again.'
                    });
                }
            }
            
            render();
        }

        init();

        let touchStartY = 0;
        let touchCurrentY = 0;

        document.addEventListener('touchstart', (e) => {
            if (state.showDetailsPanel && e.target.closest('.bottom-sheet')) {
                touchStartY = e.touches[0].clientY;
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (state.showDetailsPanel && touchStartY > 0) {
                touchCurrentY = e.touches[0].clientY;
                const diff = touchCurrentY - touchStartY;
                if (diff > 0) {
                    const sheet = document.querySelector('.bottom-sheet');
                    if (sheet) {
                        sheet.style.transform = `translateY(${diff}px)`;
                    }
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (state.showDetailsPanel && touchStartY > 0) {
                const diff = touchCurrentY - touchStartY;
                if (diff > 100) {
                    closeDetailsPanel();
                }
                const sheet = document.querySelector('.bottom-sheet');
                if (sheet) {
                    sheet.style.transform = '';
                }
                touchStartY = 0;
                touchCurrentY = 0;
            }
        }, { passive: true });
    </script>
</body>
</html>